<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zhen zhang</title>
    <style>
       body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: #fff;
}

/* Header */
.chat-header {
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 10;
    padding: 4px 0;
    background: #ffffff;
    color: #0a0a0a;
    text-align: center;
    border: 1px solid #ebeaea;
}
.chat-header p { margin: 0; }
.headname { font-size: 20px; font-weight: bold; }
.motto { font-size: 10px; }

/* Chat Box */
.chat-box {
    display: flex;
    flex-direction: column;
    padding: 10px 10px 80px;
    margin-top: 60px;
    height: calc(100vh - 60px);
    overflow-y: auto;
}

/* Input Section */
.chat-input-section {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 10px;
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    background: #fff;
    border-top: 1px solid #ccc;
    gap: 5px;
}
.input-box {
    flex-grow: 1;
    display: flex;
    align-items: center;
    padding: 5px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
}
.input-box input {
    flex-grow: 1;
    border: none;
    outline: none;
    padding: 5px 0;
}

/* Chat Messages (self / user) */
.chat-message {
    display: flex;
    flex-direction: column;
    margin: 10px;
}
.chat-message.self { align-items: flex-start; margin-right: auto; }
.chat-message.user { align-items: flex-end; margin-left: auto; }
.chat-message.self p,
.chat-message.user p {
    padding: 10px 14px;
    margin: 0;
    max-width: 70vw;
    border-radius: 12px;
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap: break-word;
    color: #000;
}
.chat-message.self p { background: #e0e0e0; }
.chat-message.user p { background: #95ec69; }

/* GPT Message */
.chat-message.gpt {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin: 10px auto;
    background: #eef;
}
.chat-message.gpt p {
    background: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
    padding: 12px 16px;
    border-radius: 10px;
    max-width: 60vw;
    font-family: "Courier New", Courier, monospace;
    color: #333;
    white-space: pre-wrap;
    user-select: text;
    word-break: break-word;
}

/* Timestamp */
.timestamp {
    font-size: 12px;
    color: #888;
    width: 100%;
    text-align: right;
    margin-bottom: 0;
}

/* New Message Reminder */
.new-message-reminder {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px;
    font-size: 14px;
    color: #fff;
    background: #4CAF50;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    opacity: 0.8;
    text-align: center;
}

#send-button {
  background-color: #fbfcfb;      /* 绿色背景 */
  color: rgb(170, 170, 170);                   /* 字体颜色 */
  border: none;                   /* 无边框 */
  border-radius: 8px;             /* 圆角 */
  padding: 8px 14px;             /* 内边距 */
  font-size: 24px;                /* 字号 */
  cursor: pointer;               /* 鼠标悬停样式 */
  transition: background-color 0.3s ease, transform 0.2s ease;
  line-height: 1;
  user-select: none;
  box-shadow: 0 2px 5px rgba(255, 254, 254, 0.89);
  white-space: nowrap;
   margin-right: 15px;
}

#send-button:hover {
  background: #222;
  transform: translateX(2px); /* 悬停轻微浮动 */
}

#send-button:active {
  transform: scale(0.95);       /* 点击时缩小一点 */
}

#systemMessagePopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  display: none;
  z-index: 10000;
  pointer-events: none;
  user-select: none;
}

    </style>
</head>
<body>
  <!-- Chat Header -->
  <div class="chat-header">
    <p class="headname">刁娜</p>
    <p class="motto">聊天中</p>
  </div>
  <div id="systemMessagePopup"></div>
  <!-- Chat Box -->
  <div class="chat-box" id="chat-box"></div>
  <!-- Input Section -->
  <div class="chat-input-section">
  <!-- Input Box -->
    <div class="input-box"> 
      <input type="text" id="message-input" placeholder="请输入...">
    </div>
    <button id="send-button">➤</button>
  </div>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io('https://dn.zhe.nz');
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("message-input");
const sendButton = document.getElementById("send-button");
const systemMessagePopup = document.getElementById("systemMessagePopup");
const renderedMessages = new Set();
const room = window.location.pathname.split("/").pop().replace(".html", "");

let pendingTimestamps = JSON.parse(localStorage.getItem('pendingTimestamps') || '[]');
let sentMessageTimestamps = JSON.parse(localStorage.getItem('sentMessageTimestamps') || '[]');

// 封装更新 localStorage 函数【简化点1】
function updateStorage() {
  localStorage.setItem('pendingTimestamps', JSON.stringify(pendingTimestamps));
  localStorage.setItem('sentMessageTimestamps', JSON.stringify(sentMessageTimestamps));
}

socket.on("connect", () => {
  socket.emit('join room', room);
  loadChatHistory(room);
});

socket.on("system message", (msg) => {
  systemMessagePopup.innerText = msg;
  systemMessagePopup.style.display = "block";
  setTimeout(() => systemMessagePopup.style.display = "none", 3000);
});

sendButton.addEventListener("click", sendTextMessage);
input.addEventListener("keydown", e => e.key === "Enter" && sendTextMessage());

function sendTextMessage() {
  const text = input.value.trim();
  if (!text) return;
  const now = Date.now();
  pendingTimestamps.push(now);
  updateStorage();  //【简化点1】

  socket.emit('chat message', { room, text, clientTimestamp: now });
  input.value = "";
}

socket.on('chat message', (msg) => {
  const index = pendingTimestamps.findIndex(t => Math.abs(t - msg.clientTimestamp) < 100);
  let sender;
  if (msg.role === "assistant") sender = "gpt";
  else if (index !== -1) {
    sender = "self";
    pendingTimestamps.splice(index, 1);
    if (!sentMessageTimestamps.includes(msg.timestamp)) sentMessageTimestamps.push(msg.timestamp);
    updateStorage();  //【简化点1】
  } else sender = "user";

  appendMessage(msg.text, sender, msg.timestamp, msg.id);
});

// 用箭头函数和三元表达式简化时间戳转换【简化点2】
const toMillisTimestamp = time => typeof time === 'number' ? time : (typeof time === 'string' ? new Date(time).getTime() : 0);

async function loadChatHistory(room) {
  try {
    const res = await fetch(`https://dn.zhe.nz/api/chat-history/${room}`);
    if (!res.ok) throw new Error('获取历史记录失败');
    const messages = await res.json();
    sentMessageTimestamps = JSON.parse(localStorage.getItem('sentMessageTimestamps') || '[]');

    messages.forEach(msg => {
      let sender = msg.role === "assistant" ? "gpt" :
        sentMessageTimestamps.some(t => Math.abs(toMillisTimestamp(t) - toMillisTimestamp(msg.timestamp)) < 100) ? "self" : "user";
      appendMessage(msg.text, sender, msg.timestamp, msg.id);
    });
  } catch (e) {
    console.error(e);
  }
}

function appendMessage(text, sender, timeStr, id) {
  id = id || `${text}|${timeStr}`;
  if (renderedMessages.has(id)) return;
  renderedMessages.add(id);

  const msg = document.createElement("div");
  msg.className = `chat-message ${sender}`;

  const time = document.createElement("div");
  time.className = "timestamp";
  time.innerText = timeStr ? new Date(timeStr).toLocaleString() : new Date().toLocaleString();

  const bubble = document.createElement("p");
  bubble.innerText = text;

  msg.appendChild(time);
  msg.appendChild(bubble);
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

</script>

      
</body>
</html>
